(function() {
    function getChannelUniqueCode() {
        var scripts = document.scripts,
        trackEventJsUri = "/trackEvent.",
        regStr = ".js?",
        i, index;
        for (i = 0; i < scripts.length; i++) {
            if (scripts[i].src && scripts[i].src.indexOf(trackEventJsUri) !== -1) {
                src = scripts[i].src
            }
        }
        index = src.lastIndexOf(regStr);
        channelUniqueCode = index !== -1 ? src.substr(index + regStr.length) : "getChannelUniqueCodeError";
        return channelUniqueCode
    }
    function parse(sJSON) {
        if (JSON && JSON.parse) {
            return JSON.parse(sJSON)
        }
        return eval("(" + sJSON + ")")
    }
    var stringify = (function() {
        var toString = Object.prototype.toString;
        var isArray = Array.isArray ||
        function(a) {
            return toString.call(a) === "[object Array]"
        };
        var escMap = {
            '"': '\\"',
            "\\": "\\\\",
            "\b": "\\b",
            "\f": "\\f",
            "\n": "\\n",
            "\r": "\\r",
            "\t": "\\t"
        };
        var escFunc = function(m) {
            return escMap[m] || "\\u" + (m.charCodeAt(0) + 65536).toString(16).substr(1)
        };
        var escRE = /[\\"\u0000-\u001F\u2028\u2029]/g;
        return function(value) {
            if (value == null) {
                return "null"
            } else {
                if (typeof value === "number") {
                    return isFinite(value) ? value.toString() : "null"
                } else {
                    if (typeof value === "boolean") {
                        return value.toString()
                    } else {
                        if (typeof value === "object") {
                            if (typeof value.toJSON === "function") {
                                return stringify(value.toJSON())
                            } else {
                                if (isArray(value)) {
                                    var res = "[";
                                    for (var i = 0; i < value.length; i++) {
                                        res += (i ? ", ": "") + stringify(value[i])
                                    }
                                    return res + "]"
                                } else {
                                    if (toString.call(value) === "[object Object]") {
                                        var tmp = [];
                                        for (var k in value) {
                                            if (value.hasOwnProperty(k)) {
                                                tmp.push(stringify(k) + ": " + stringify(value[k]))
                                            }
                                        }
                                        return "{" + tmp.join(", ") + "}"
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return '"' + value.toString().replace(escRE, escFunc) + '"'
        }
    })();
    var generatorSrc = function(obj, src) {
        for (e in obj) {
            if (typeof(obj[e]) == "object") {
                src = generatorSrc(obj[e], src)
            }
            if (obj[e]) {
                src += e + "=" + obj[e] + "&"
            }
        }
        return src
    };
    var getCurrentUser = function() {
        var user = getCookies("sj_stu");
        try {
            return JSON.parse(user)
        } catch(SyntaxError) {
            return {}
        }
    };
    var setCurrentUser = function(user) {
        setcookies("sj_stu", JSON.stringify(user), 999)
    };
    var generatorUUID = function() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 16), 1)
        }
        s[14] = "4";
        s[19] = hexDigits.substr((s[19] & 3) | 8, 1);
        s[8] = s[13] = s[18] = s[23] = "-";
        var uuid = s.join("");
        return uuid
    };
    var setcookies = function(key, value, expiredays, path, domain, secure) {
        var str = key + "=" + escape(value);
        if (expiredays > 0) {
            var date = new Date();
            var ms = expiredays * 3600 * 1000;
            date.setTime(date.getTime() + ms);
            str += "; expires=" + date.toGMTString()
        }
        str = key + "=" + escape(value) + "; expires=" + date.toGMTString() + ((path) ? "; path=" + path: "") + ((domain) ? "; domain=" + domain: "") + ((secure) ? "; secure": "");
        document.cookie = str
    };
    var getCookies = function(key) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(key + "=");
            if (c_start != -1) {
                c_start = c_start + key.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) {
                    c_end = document.cookie.length
                }
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
    };
    var isMobile = function() {
        if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
            return 1
        }
        return 0
    };
    function getOpenId() {
        var CURRENT_SOURCE_ID_COOKIE_KEY = "weixinCurrentSourceId",
        AUTH_COOKIE_KEY = "weixinAuthInfo",
        sourceId, openId, info = {};
        sourceId = getCookies(CURRENT_SOURCE_ID_COOKIE_KEY);
        console.log("s", sourceId);
        if (sourceId) {
            info = parse(getCookies(AUTH_COOKIE_KEY)) || {}
        }
        console.log("info", info[sourceId]);
        return info[sourceId]
    }
    var flashChecker = function() {
        var hasFlash = 0;
        var flashVersion = 0;
        if (document.all) {
            var swf = new ActiveXObject("ShockwaveFlash.ShockwaveFlash");
            if (swf) {
                hasFlash = 1;
                VSwf = swf.GetVariable("$version");
                flashVersion = parseInt(VSwf.split(" ")[1].split(",")[0])
            }
        } else {
            if (navigator.plugins && navigator.plugins.length > 0) {
                var swf = navigator.plugins["Shockwave Flash"];
                if (swf) {
                    hasFlash = 1;
                    var words = swf.description.split(" ");
                    for (var i = 0; i < words.length; ++i) {
                        if (isNaN(parseInt(words[i]))) {
                            continue
                        }
                        flashVersion = parseInt(words[i])
                    }
                }
            }
        }
        return flashVersion
    };
    var obj = {};
    var originSrc = location.protocol + "//xbbapi.data88.cn/statistics/sj.gif?";
    obj.user = getCurrentUser();
    obj.channel = getChannelUniqueCode();
    var img = document.createElement("img");
    obj.sj_v = "0.0.1";
    obj.sj_id = "123";
    obj.sj_gi = (new Date()).getTime();
    obj.sj_br = navigator.userAgent;
    obj.sj_mb = isMobile();
    obj.sj_rr = window.screen.height + "X" + window.screen.width;
    obj.sj_d = document.domain;
    obj.sj_c = document.charset;
    obj.sj_ln = window.navigator.language;
    obj.sj_jdk = navigator.javaEnabled() ? 1 : 0;
    obj.sj_fl = flashChecker();
    obj.sj_tt = document.title;
    var startTime = new Date();
    _newtank("LOAD");
    function _newtank(event, alias, tag) {
        if (!event) {
            return
        }
        obj.sj_ev = event;
        if (!obj.user.uuid) {
            obj.user.uuid = generatorUUID();
            obj.user.nv = 1;
            obj.user.uvt = 0
        } else {
            obj.user.nv = 0
        }
        if (alias) {
            obj.alias = alias
        } else {
            if (obj.alias) {
                obj.alias = ""
            }
        }
        if (tag) {
            var tagStr = stringify(tag);
            if (!/^{/.test(tagStr)) {
                tagStr = stringify({
                    key: tag
                })
            }
        } else {
            tagStr = stringify({})
        }
        var openId = getOpenId();
        if (openId) {
            tagStr = "{openId:" + openId + "," + tagStr.substr(1)
        }
        obj.tags = encodeURIComponent(tagStr);
        obj.user.uvt++;
        setCurrentUser(obj.user);
        startTime = new Date();
        obj.user.utp = startTime.getTime();
        obj.url = encodeURIComponent(window.location.href);
        var img = new Image();
        var src = generatorSrc(obj, originSrc);
        img.src = src.substring(0, src.length - 1)
    }
    if (("onhashchange" in window) && ((typeof document.documentMode === "undefined") || document.documentMode === 8)) {
        window.onhashchange = hashChangeFire
    } else {
        var currentUrl = window.location.href;
        setInterval(function() {
            var isChanged = currentUrl !== window.location.href;
            if (isChanged) {
                hashChangeFire()
            }
        },
        150)
    }
    function hashChangeFire() {
        _newtank("URL_CHANGE")
    }
    window._newtank = _newtank;
    window.onbeforeunload = function() {
        obj.sj_ev = "EXIT";
        var endTime = new Date();
        obj.user.utp = endTime.getTime();
        obj.url = encodeURIComponent(window.location.href);
        var img = new Image();
        var src = generatorSrc(obj, originSrc);
        img.src = generatorSrc(obj, src).substring(0, src.length - 1)
    }
})();